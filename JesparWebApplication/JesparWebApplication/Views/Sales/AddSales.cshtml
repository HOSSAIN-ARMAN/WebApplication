@model JesparWebApplication.Models.SalesViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Mystyle{

    <link href="../Content/bootstrap.min.css" rel="stylesheet" />
    @*<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">*@
    @*<style>
            .btn {
                border: double;
            }
        </style>*@
}

<div class="container">
    <hr />
    <div class="row">
        <div class="col-md-12">
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <div class="grid-header">

                            <label class="col-md-5 text-info">---**Customer**---</label>
                            <div class="col-md-7"></div>
                            <hr />
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Customer</label>
                                <div class="col-sm-8">
                                    @Html.DropDownList("Customer", null, "--Select--", new { @class = "form-control" })

                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Date</label>
                                <div class="col-sm-8">
                                    <input type="date" class="form-control" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Loyality Point</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.LoyaltyPoint, new { @class = "form-control" })
                                    @*<input type="text" id="loyaltyPoint" class="form-control"/>*@
                                </div>
                            </div>
                        </div>

                        <div class="card-body">

                            <label class="col-md-4 text-info">---**Product**---</label>
                            <hr />

                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Category</label>
                                <div class="col-sm-8">
                                    @Html.DropDownList("Category", null, "--Select--", new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Product</label>
                                <div class="col-sm-8">
                                    <select id="ProductId" class="form-control">
                                        <option value=-1>--select--</option>

                                    </select>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Available Quantity</label>
                                <div class="col-sm-8">
                                    <input type="text" id="availableQty" class="form-control" value="0" />
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Quantity</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.Quantity, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">MRP</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.MRP, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Total MRP</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.TotalMrp, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label"></label>
                                <div class="col-sm-8">
                                    <input type="button" id="addSales" class="form-control btn-outline-light" value="Add" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">

                <div class="Row">
                    <div class="col-md-12">
                        <div class="grid-header">
                            <label class="col-md-5 text-info">---**Sales Details**---</label>
                            <div class="col-md-7"></div>
                            <hr />
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Grand Total</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.GrandTotal, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Discount</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.Discount, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Discount Ammount</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.DiscountAmmount, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-4 col-form-label">Payable Ammount</label>
                                <div class="col-sm-8">
                                    @Html.TextBoxFor(c => c.PayableAmmount, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="colFormLabel" class="col-sm-8 col-form-label"></label>
                                <div class="col-sm-4">
                                    <input type="submit" value="Submit" class="form-control btn-outline-dark" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <hr />
                        <div class="mce-grid-border">
                            <table class="table table-bordered" id="salesTable">

                                <thead class="thead-dark">
                                    <tr>
                                        <th>SL</th>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>MRP</th>
                                        <th>Total MRP</th>
                                        <th>Action</th>

                                    </tr>
                                </thead>

                            </table>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


@section MyScript{


    <script src="~/Scripts/jquery-3.3.1.min.js"></script>

    <script src="~/Scripts/bootstrap.min.js"></script>


    <script type="text/javascript">
        $(document).ready(function () {
            $("#Customer").change(function () {
                var customerId = $("#Customer").val();
                var jsonRequestData = { customerId: customerId };
                $.ajax({
                    url: "/Sales/GetLoyaltyPointByCustomerId",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (loyaltyPoint) {
                        $("#LoyaltyPoint").val(loyaltyPoint);
                    },
                    error: function () {
                        alert("ajax Not working");
                    }
                });
            });
        });
    </script>


    <script type="text/javascript">
        $(document).ready(function () {
            $("#Category").change(function () {
                var categoryId = $("#Category").val();
                var jsonRequestData = { categoryId: categoryId };
                $.ajax({
                    url: "/Purchase/GetProductByCategoryId",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (products) {

                        $("#ProductId").empty();
                        $("#ProductId").append('<Option value="' + -1 + '">' + "--select--" + '</Option>');
                        
                        $.each(products, function (key, value) {

                            $("#ProductId").append('<option value="' + value.Id + '">' + value.Name + '</option>');
                            //$("#Code").val(value.Code);
                        });
                    },
                    error: function () {
                        alert("Select Category!!!!!!!!!");
                    }
                });
            });
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function () {
            $("#ProductId").change(function () {
                var productId = $("#ProductId").val();
                var jsonRequestData = { ProductId: productId };
                $.ajax({
                    url: "/Sales/GetProductAvailableQuantityAndMrp",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (availavleQty) {                                                
                        $.each(availavleQty, function (key, value) {
                            $("#availableQty").val(value.Quantity);
                            $("#MRP").val(value.MRP);
                        });
                    },
                    error: function () {
                        alert("Select Category!!!!!!!!!");
                    }
                });
            });
        });
    </script>

    


    <script type="text/javascript">

        //create table before insert to database

        $(document).ready(function () {

            var index = 0;

            $('#addSales').click(function () {


                var result = GetResultData();
                var resultRow = GerResultRow(result);

                $("#salesTable").append(resultRow);
                index++;


                $('#GrandTotal').val(GrandTotal());
                $('#Discount').val(GetDiscount());
                $('#DiscountAmmount').val(DiscountAmmount());
                $('#PayableAmmount').val(parseInt(PayableAmmount()));
                //$("#LoyaltyPoint").val(parseFloat(ResetLoyaltyPoint()));

            });


            function GetResultData() {

                var product = $("#Product").val();
                var quantity = $("#Quantity").val();
                var mrp = $("#MRP").val();
                var totalMrp = $('#TotalMrp').val();


                return { Product: product, Quantity: quantity, Mrp: mrp, TotalMrp: totalMrp }
            }


            var sl = index;
            function GerResultRow(result) {


                var productHidden = "<input type='hidden' name='Product[" + index + "].Product' value='" + result.Product + "'></div>";
                var quantityHidden = "<input type='hidden' name='Quantity[" + index + "].Quantity' value='" + result.Quantity + "'></div>";

                var mrpHidden = "<input type='hidden' name='MRP[" + index + "].Mrp' value='" + result.Mrp + "'></div>";
                var totalMrpHidden = "<input type='hidden' id='totlmp'  name='totalMrp[" + index + "].TotalMrp' value='" + result.TotalMrp + "'></div>";



                var startTr = "<tr>";
                var slCell = "<td class='text-success'>" + (++sl) + "</td>";
                var productCell = "<td class='text-success'>" + productHidden + result.Product + "</td>";
                var quantityCell = "<td class='text-success'>" + quantityHidden + result.Quantity + "</td>";
                var mrpCell = "<td class='text-success'>" + mrpHidden + result.Mrp + "</td>";
                var totalPriceCell = "<td  class='text-success'>" + totalMrpHidden + result.TotalMrp + "</td>";

                var endTr = "</tr>";


                return (startTr + slCell + productCell + quantityCell + mrpCell + totalPriceCell + endTr);

            }

            function GrandTotal() {
                var sum = 0;
                if (!isNaN($("#GrandTotal").val())) {
                    sum += parseFloat($("#GrandTotal").val());
                }
                var totalMrp = parseFloat($("#TotalMrp").val());
                sum += totalMrp;
                return sum;
            }

            function GetDiscount() {
                var loyaltyPoint = $("#LoyaltyPoint").val();
                var discount = loyaltyPoint / 10;
                return discount;
            }

            function DiscountAmmount() {
                var discount = $("#Discount").val();
                var grandTotal = $("#GrandTotal").val();
                var discountAmmount = grandTotal * (discount / 100);
                return discountAmmount;
            }

            function PayableAmmount() {
                var grandTotal = $("#GrandTotal").val();
                var discountAmmount = $("#DiscountAmmount").val();
                var payableAmmount = grandTotal - discountAmmount;
                return payableAmmount;
            }

            //function ResetLoyaltyPoint() {
            //    var loyaltyPoint = $("#LoyaltyPoint").val();
            //    var discount = parseFloat($("#Discount").val());
            //    var resetLoyaltyPoint = loyaltyPoint - discount;
            //    return resetLoyaltyPoint;
            //}



        });


    </script>






}

